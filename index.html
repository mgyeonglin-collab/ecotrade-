<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TrashTrade â€” Part 1 (Core)</title>
<link href="https://fonts.googleapis.com/css2?family=Gowun+Batang&display=swap" rel="stylesheet">
<style>
:root{
  --main-green:#6BA368;
  --light-green:#A1C181;
  --ivory:#F7F4EA;
  --accent-yellow:#F9CC66;
  --text-dark:#2B2B2B;
  --muted:#6f6f6f;
  --card-shadow: 0 6px 18px rgba(0,0,0,0.06);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:'Gowun Batang',serif;
  background:var(--ivory) url('https://www.transparenttextures.com/patterns/paper-fibers.png');
  color:var(--text-dark);
  -webkit-font-smoothing:antialiased;
  line-height:1.45;
  padding-bottom:60px;
}

/* Header */
.header{
  display:flex;align-items:center;justify-content:space-between;padding:14px 22px;background:var(--light-green);
  color:#fff;border-bottom:3px solid var(--main-green);
}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--main-green),var(--light-green));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
.header-actions{display:flex;gap:10px;align-items:center}
.btn{background:var(--accent-yellow);border:none;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
.icon-btn{background:transparent;border:none;color:#fff;cursor:pointer;font-weight:700;padding:8px}

/* Layout */
.container{max-width:1100px;margin:18px auto;padding:0 18px}
.hero{background:#fff;border-radius:14px;padding:20px;margin:16px 0;box-shadow:var(--card-shadow);text-align:center}
.hero h2{color:var(--main-green);font-size:24px;margin-bottom:8px}
.controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:14px}
.controls input,.controls select{padding:8px 10px;border-radius:10px;border:1px solid #e6e6e6}

/* Grid / Cards */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;max-width:1100px;margin:0 auto}
.card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:var(--card-shadow);display:flex;flex-direction:column;transition:transform .15s}
.card:hover{transform:translateY(-6px)}
.card img{width:100%;height:160px;object-fit:cover}
.card-content{padding:12px;display:flex;flex-direction:column;gap:8px}
.card-content h3{color:var(--main-green);font-size:17px}
.card-content p{color:#444;font-size:14px;min-height:44px}
.card-footer{display:flex;justify-content:space-between;align-items:center;margin-top:auto}
.tag{background:var(--light-green);color:#fff;padding:6px 10px;border-radius:8px;font-size:13px}
.exchange-btn{background:var(--main-green);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}

/* Panel (right) */
.panel-toggle{position:fixed;right:18px;top:96px;width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--main-green),var(--light-green));color:#fff;border:none;cursor:pointer;z-index:60}
.panel{position:fixed;right:-380px;top:0;width:360px;height:100%;background:#fff;box-shadow:-8px 0 30px rgba(0,0,0,0.12);padding:16px;transition:right .35s;z-index:59;overflow:auto}
.panel.open{right:0}
.section{margin-bottom:14px;padding-bottom:12px;border-bottom:1px dashed #f0f0f0}
.profile-row{display:flex;align-items:center;gap:10px}
.avatar{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--main-green),var(--light-green));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
.small{font-size:13px;color:var(--muted)}
.chat-list{max-height:220px;overflow:auto}
.chat-item{padding:8px;border-radius:8px;border:1px solid #f0f0f0;margin-bottom:8px;cursor:pointer}
.chat-item:hover{background:#fafafa}

/* Modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:70}
.modal{background:#fff;border-radius:12px;padding:16px;max-width:820px;width:100%;max-height:90vh;overflow:auto}
.form-row{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap}
.form-row input[type="text"],.form-row textarea,.form-row select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e6e6}
.form-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
.preview{width:140px;height:100px;border-radius:8px;background:#f3f3f3;display:flex;align-items:center;justify-content:center;color:#999}

/* Responsive */
@media(max-width:900px){ .grid{grid-template-columns:repeat(2,1fr)} .panel{width:320px} .panel.open{right:0} .panel-toggle{right:12px} }
@media(max-width:600px){ .grid{grid-template-columns:repeat(1,1fr)} .panel{width:100%;right:-100%} .panel.open{right:0} .panel-toggle{display:none} }
</style>
</head>
<body>

<div class="header">
  <div class="brand">
    <div class="logo">TT</div>
    <div>
      <div style="font-weight:800;font-size:18px">TrashTrade ğŸŒ¿</div>
      <div class="small">ì§€ì—­ ê¸°ë°˜ ìì› êµí™˜ (ì‹œÂ·ë„ â†’ ì‹œÂ·êµ°Â·êµ¬)</div>
    </div>
  </div>
  <div class="header-actions">
    <button class="btn" id="btnRegister">ë¬¼í’ˆ ë“±ë¡</button>
    <button class="btn" id="btnLogin">ë¡œê·¸ì¸ / íšŒì›</button>
    <button class="btn" id="btnMyActivity">ë‚´ í™œë™</button>
    <button id="panelToggle" class="panel-toggle" title="ì‚¬ì´ë“œ íŒ¨ë„ ì—´ê¸°">â˜°</button>
  </div>
</div>

<div class="container">
  <section class="hero">
    <h2>ì§€ì—­ì—ì„œ ì‹œì‘í•˜ëŠ” ìˆœí™˜ â€” TrashTrade</h2>
    <p class="small">íšŒì›ê°€ì… í›„ ë¬¼í’ˆì„ ë“±ë¡í•˜ì„¸ìš”. êµí™˜ ì œì•ˆ â†’ ìˆ˜ë½ â†’ ê±°ë˜ ì™„ë£Œ íë¦„ì´ ì‘ë™í•©ë‹ˆë‹¤.</p>
  </section>

  <div class="controls">
    <input id="searchInput" placeholder="ë¬¼í’ˆëª… ë˜ëŠ” ì„¤ëª… ê²€ìƒ‰">
    <select id="categoryFilter">
      <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
      <option value="ì±…">ì±…</option>
      <option value="ì˜ë¥˜">ì˜ë¥˜</option>
      <option value="ì „ìê¸°ê¸°">ì „ìê¸°ê¸°</option>
      <option value="ê¸°íƒ€">ê¸°íƒ€</option>
    </select>
    <select id="sidoSelect"><option value="">ì‹œÂ·ë„ ì„ íƒ</option></select>
    <select id="sigunSelect"><option value="">ì‹œÂ·êµ°Â·êµ¬ ì„ íƒ</option></select>
  </div>

  <div id="grid" class="grid" aria-live="polite"></div>

  <div id="dashboardArea"></div>
</div>

<!-- Side Panel -->
<div id="panel" class="panel" aria-hidden="true">
  <div class="section">
    <div class="profile-row">
      <div class="avatar" id="avatar">?</div>
      <div>
        <div id="profileName" style="font-weight:800">ë¹„ë¡œê·¸ì¸</div>
        <div id="profileSchool" class="small">í•™êµ/ì§€ì—­ ì…ë ¥ í•„ìš”</div>
        <div class="small">í¬ì¸íŠ¸: <span id="profilePoints">0</span> Â· êµí™˜: <span id="profileTrades">0</span></div>
      </div>
    </div>
  </div>

  <div class="section">
    <h4>ì•Œë¦¼</h4>
    <div id="notifList" style="max-height:200px;overflow:auto"></div>
  </div>

  <div class="section">
    <h4>ì±„íŒ…</h4>
    <div id="chatList" class="chat-list"></div>
  </div>

  <div class="section">
    <h4>ë„ì›€ë§</h4>
    <div class="small">ê²°ì œ/ë°°ì†¡ ì—°ê²°ì€ ë°±ì—”ë“œ ì—°ë™ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤. í˜„ì¬ í´ë¼ì´ì–¸íŠ¸ëŠ” ë¡œì»¬ ì €ì¥ì†Œ ê¸°ë°˜ ì‘ë™ì…ë‹ˆë‹¤.</div>
  </div>
</div>

<!-- Modal -->
<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
  <div id="modal" class="modal"></div>
</div>

<script>
/* =========================
   TrashTrade - Part 1 (Core)
   - No dummy users/items
   - Full region select (ì‹œÂ·ë„ -> ì‹œÂ·êµ°Â·êµ¬ for many regions)
   - Register / Login / Item register / Request / Chat (localStorage)
   - Panel toggle
   ========================= */

/* ---------- Storage keys ---------- */
const STORAGE = {
  USERS: 'tt_users_core_v1',
  ITEMS: 'tt_items_core_v1',
  REQS: 'tt_reqs_core_v1',
  CHATS: 'tt_chats_core_v1'
};

/* ---------- Utilities ---------- */
const util = (function(){
  function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }
  function load(key){ try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch(e){ console.error('load err',e); return []; } }
  function save(key, data){ localStorage.setItem(key, JSON.stringify(data)); }
  function now(){ return Date.now(); }
  return { uid, load, save, now };
})();

/* ---------- Region list (ì‹œÂ·ë„ -> ì‹œÂ·êµ°Â·êµ¬) ----------
   This list contains major administrative districts for every province.
   You can replace/extend with an official dataset or load from server in production.
*/
const REGION = {
  'ì„œìš¸íŠ¹ë³„ì‹œ': ['ê°•ë‚¨êµ¬','ê°•ë™êµ¬','ê°•ë¶êµ¬','ê°•ì„œêµ¬','ê´€ì•…êµ¬','ê´‘ì§„êµ¬','êµ¬ë¡œêµ¬','ê¸ˆì²œêµ¬','ë…¸ì›êµ¬','ë„ë´‰êµ¬','ë™ëŒ€ë¬¸êµ¬','ë™ì‘êµ¬','ë§ˆí¬êµ¬','ì„œëŒ€ë¬¸êµ¬','ì„œì´ˆêµ¬','ì„±ë™êµ¬','ì„±ë¶êµ¬','ì†¡íŒŒêµ¬','ì–‘ì²œêµ¬','ì˜ë“±í¬êµ¬','ìš©ì‚°êµ¬','ì€í‰êµ¬','ì¢…ë¡œêµ¬','ì¤‘êµ¬','ì¤‘ë‘êµ¬'],
  'ë¶€ì‚°ê´‘ì—­ì‹œ': ['ê°•ì„œêµ¬','ê¸ˆì •êµ¬','ê¸°ì¥êµ°','ë‚¨êµ¬','ë™êµ¬','ë™ë˜êµ¬','ë¶€ì‚°ì§„êµ¬','ë¶êµ¬','ì‚¬ìƒêµ¬','ì‚¬í•˜êµ¬','ì„œêµ¬','ìˆ˜ì˜êµ¬','ì—°ì œêµ¬','ì˜ë„êµ¬','ì¤‘êµ¬'],
  'ëŒ€êµ¬ê´‘ì—­ì‹œ': ['ë‚¨êµ¬','ë‹¬ì„œêµ¬','ë‹¬ì„±êµ°','ë™êµ¬','ë¶êµ¬','ì„œêµ¬','ìˆ˜ì„±êµ¬','ì¤‘êµ¬'],
  'ì¸ì²œê´‘ì—­ì‹œ': ['ê°•í™”êµ°','ê³„ì–‘êµ¬','ë¯¸ì¶”í™€êµ¬','ë‚¨ë™êµ¬','ë™êµ¬','ë¶€í‰êµ¬','ì„œêµ¬','ì—°ìˆ˜êµ¬','ì˜¹ì§„êµ°'],
  'ê´‘ì£¼ê´‘ì—­ì‹œ': ['ê´‘ì‚°êµ¬','ë‚¨êµ¬','ë™êµ¬','ë¶êµ¬','ì„œêµ¬'],
  'ëŒ€ì „ê´‘ì—­ì‹œ': ['ëŒ€ë•êµ¬','ë™êµ¬','ì„œêµ¬','ìœ ì„±êµ¬','ì¤‘êµ¬'],
  'ìš¸ì‚°ê´‘ì—­ì‹œ': ['ë‚¨êµ¬','ë™êµ¬','ë¶êµ¬','ìš¸ì£¼êµ°','ì¤‘êµ¬'],
  'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ': ['ì„¸ì¢…ì‹œ'],
  'ê²½ê¸°ë„': ['ìˆ˜ì›ì‹œ','ì„±ë‚¨ì‹œ','ê³ ì–‘ì‹œ','ìš©ì¸ì‹œ','ë¶€ì²œì‹œ','í™”ì„±ì‹œ','ë‚¨ì–‘ì£¼ì‹œ','ì•ˆì‚°ì‹œ','ì•ˆì–‘ì‹œ','í‰íƒì‹œ','ì˜ì •ë¶€ì‹œ','ì‹œí¥ì‹œ','íŒŒì£¼ì‹œ','ê´‘ëª…ì‹œ','ê¹€í¬ì‹œ','ê´‘ì£¼ì‹œ','í•˜ë‚¨ì‹œ','ì´ì²œì‹œ','ì–‘ì£¼ì‹œ','ì˜¤ì‚°ì‹œ','êµ¬ë¦¬ì‹œ','êµ°í¬ì‹œ','ì–‘í‰êµ°','ì—°ì²œêµ°','ì—¬ì£¼ì‹œ','ê°€í‰êµ°','í¬ì²œì‹œ'],
  'ê°•ì›ë„': ['ê°•ë¦‰ì‹œ','ê³ ì„±êµ°','ë™í•´ì‹œ','ì‚¼ì²™ì‹œ','ì†ì´ˆì‹œ','ì–‘êµ¬êµ°','ì–‘ì–‘êµ°','ì˜ì›”êµ°','ì›ì£¼ì‹œ','ì¸ì œêµ°','ì¶˜ì²œì‹œ','íƒœë°±ì‹œ','í‰ì°½êµ°','í™ì²œêµ°','í™”ì²œêµ°','íš¡ì„±êµ°'],
  'ì¶©ì²­ë¶ë„': ['ì²­ì£¼ì‹œ','ì¶©ì£¼ì‹œ','ì œì²œì‹œ','ë³´ì€êµ°','ì˜¥ì²œêµ°','ì˜ë™êµ°','ì§„ì²œêµ°','ê´´ì‚°êµ°','ìŒì„±êµ°','ë‹¨ì–‘êµ°'],
  'ì¶©ì²­ë‚¨ë„': ['ì²œì•ˆì‹œ','ê³µì£¼ì‹œ','ë³´ë ¹ì‹œ','ì•„ì‚°ì‹œ','ì„œì‚°ì‹œ','ë…¼ì‚°ì‹œ','ê³„ë£¡ì‹œ','ë‹¹ì§„ì‹œ','ê¸ˆì‚°êµ°','ë¶€ì—¬êµ°','ì„œì²œêµ°','ì²­ì–‘êµ°','íƒœì•ˆêµ°','í™ì„±êµ°'],
  'ì „ë¼ë¶ë„': ['ì „ì£¼ì‹œ','êµ°ì‚°ì‹œ','ìµì‚°ì‹œ','ì •ìì‹œ','ë‚¨ì›ì‹œ','ê¹€ì œì‹œ','ì™„ì£¼êµ°','ì§„ì•ˆêµ°','ë¬´ì£¼êµ°','ì¥ìˆ˜êµ°','ì„ì‹¤êµ°','ìˆœì°½êµ°','ê³ ì°½êµ°','ë¶€ì•ˆêµ°'],
  'ì „ë¼ë‚¨ë„': ['ëª©í¬ì‹œ','ì—¬ìˆ˜ì‹œ','ìˆœì²œì‹œ','ë‚˜ì£¼ì‹œ','ê´‘ì–‘ì‹œ','ë¬´ì•ˆêµ°','ì˜ì•”êµ°','ì‹ ì•ˆêµ°','í™”ìˆœêµ°','ê³ í¥êµ°','ì¥í¥êµ°','ê°•ì§„êµ°','í•´ë‚¨êµ°','ì™„ë„êµ°','ë³´ì„±êµ°','ê³¡ì„±êµ°','ë‹´ì–‘êµ°','ì˜ê´‘êµ°','ì¥ì„±êµ°','ì§„ë„êµ°','í•¨í‰êµ°'],
  'ê²½ìƒë¶ë„': ['í¬í•­ì‹œ','ê²½ì£¼ì‹œ','ê¹€ì²œì‹œ','ì•ˆë™ì‹œ','êµ¬ë¯¸ì‹œ','ì˜ì£¼ì‹œ','ì˜ì²œì‹œ','ìƒì£¼ì‹œ','ë¬¸ê²½ì‹œ','ê²½ì‚°ì‹œ','êµ°ìœ„êµ°','ì˜ì„±êµ°','ì²­ì†¡êµ°','ì˜ì–‘êµ°','ì˜ë•êµ°','ì²­ë„êµ°','ê³ ë ¹êµ°','ì„±ì£¼êµ°','ì¹ ê³¡êµ°','ì˜ˆì²œêµ°','ìš¸ì§„êµ°','ë´‰í™”êµ°','ìš¸ë¦‰êµ°'],
  'ê²½ìƒë‚¨ë„': ['ì°½ì›ì‹œ','ê¹€í•´ì‹œ','ì–‘ì‚°ì‹œ','ì§„ì£¼ì‹œ','í†µì˜ì‹œ','ì‚¬ì²œì‹œ','ê±°ì œì‹œ','ë°€ì–‘ì‹œ','í•¨ì•ˆêµ°','ê±°ì°½êµ°','í•©ì²œêµ°','ì°½ë…•êµ°','í•˜ë™êµ°','ì‚°ì²­êµ°','ë‚¨í•´êµ°','ì˜ë ¹êµ°','ê³ ì„±êµ°','í•¨ì–‘êµ°'],
  'ì œì£¼íŠ¹ë³„ìì¹˜ë„': ['ì œì£¼ì‹œ','ì„œê·€í¬ì‹œ']
};

/* ---------- Initialize storage (empty arrays, no dummy users/items) ---------- */
(function initStorage(){
  if(!localStorage.getItem(STORAGE.USERS)) util.save(STORAGE.USERS, []);
  if(!localStorage.getItem(STORAGE.ITEMS)) util.save(STORAGE.ITEMS, []);
  if(!localStorage.getItem(STORAGE.REQS)) util.save(STORAGE.REQS, []);
  if(!localStorage.getItem(STORAGE.CHATS)) util.save(STORAGE.CHATS, []);
})();

/* ---------- Application State ---------- */
let users = util.load(STORAGE.USERS);
let items = util.load(STORAGE.ITEMS);
let requests = util.load(STORAGE.REQS);
let chats = util.load(STORAGE.CHATS);
let currentUserId = localStorage.getItem('tt_current_user') || null;

/* ---------- DOM refs ---------- */
const sidoSelect = document.getElementById('sidoSelect');
const sigunSelect = document.getElementById('sigunSelect');
const gridEl = document.getElementById('grid');
const panelEl = document.getElementById('panel');
const panelToggleBtn = document.getElementById('panelToggle');
const modalBackdrop = document.getElementById('modalBackdrop');
const modalEl = document.getElementById('modal');

/* ---------- Helpers ---------- */
function persistAll(){
  util.save(STORAGE.USERS, users);
  util.save(STORAGE.ITEMS, items);
  util.save(STORAGE.REQS, requests);
  util.save(STORAGE.CHATS, chats);
  if(currentUserId) localStorage.setItem('tt_current_user', currentUserId); else localStorage.removeItem('tt_current_user');
}

function findUser(id){ return users.find(u=>u.id===id) || null; }
function findItem(id){ return items.find(i=>i.id===id) || null; }
function findChat(id){ return chats.find(c=>c.id===id) || null; }

/* ---------- Region selects population ---------- */
function populateSido(){
  sidoSelect.innerHTML = '<option value="">ì‹œÂ·ë„ ì„ íƒ</option>';
  Object.keys(REGION).forEach(sido=>{
    const opt = document.createElement('option'); opt.value=sido; opt.textContent=sido; sidoSelect.appendChild(opt);
  });
  sidoSelect.addEventListener('change', ()=>{
    const s = sidoSelect.value;
    sigunSelect.innerHTML = '<option value="">ì‹œÂ·êµ°Â·êµ¬ ì„ íƒ</option>';
    if(s && REGION[s]){
      REGION[s].forEach(sg=>{
        const o = document.createElement('option'); o.value=sg; o.textContent=sg; sigunSelect.appendChild(o);
      });
    }
    renderGrid();
  });
  sigunSelect.addEventListener('change', ()=> renderGrid());
}
populateSido();

/* ---------- Panel toggle ---------- */
panelToggleBtn.addEventListener('click', ()=> {
  panelEl.classList.toggle('open');
  renderPanel();
});

/* ---------- Modal helpers ---------- */
function openModal(html){
  modalEl.innerHTML = html;
  modalBackdrop.style.display = 'flex';
}
function closeModal(){ modalBackdrop.style.display = 'none'; }

/* Close modal on backdrop click */
modalBackdrop.addEventListener('click', (e)=>{ if(e.target === modalBackdrop) closeModal(); });

/* ---------- Login / User management ---------- */
document.getElementById('btnLogin').addEventListener('click', ()=> openLoginModal());
function openLoginModal(){
  openModal(`
    <h3>ë¡œê·¸ì¸ / íšŒì› ë“±ë¡</h3>
    <div class="form-row"><input id="loginName" placeholder="ì´ë¦„ (ì‹¤ëª… ë˜ëŠ” ë‹‰ë„¤ì„)"></div>
    <div class="form-row"><input id="loginSchool" placeholder="í•™êµ/ì§€ì—­"></div>
    <div class="form-actions"><button onclick="closeModal()">ì·¨ì†Œ</button><button id="loginSaveBtn">ì €ì¥</button></div>
  `);
  document.getElementById('loginSaveBtn').addEventListener('click', doLogin);
}
function doLogin(){
  const name = document.getElementById('loginName').value.trim();
  const school = document.getElementById('loginSchool').value.trim();
  if(!name || !school){ alert('ì´ë¦„ê³¼ í•™êµ/ì§€ì—­ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  users = util.load(STORAGE.USERS);
  let me = users.find(u=> u.name === name && u.school === school);
  if(!me){
    me = { id: util.uid('u'), name, school, points:0, trades:0, eco:0, created: util.now() };
    users.push(me); util.save(STORAGE.USERS, users);
  }
  currentUserId = me.id; localStorage.setItem('tt_current_user', currentUserId);
  persistAll();
  closeModal();
  renderPanel();
  renderGrid();
  alert(`${me.name}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`);
}

/* ---------- Register item (with image upload & region selection) ---------- */
document.getElementById('btnRegister').addEventListener('click', ()=> openRegisterModal());
function openRegisterModal(){
  if(!currentUserId){ alert('ë¬¼í’ˆì„ ë“±ë¡í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.'); openLoginModal(); return; }
  // build sido options small copy
  let sidoOptions = '<option value="">ì‹œÂ·ë„ ì„ íƒ</option>';
  Object.keys(REGION).forEach(s=> sidoOptions += `<option value="${s}">${s}</option>`);
  openModal(`
    <h3>ë¬¼í’ˆ ë“±ë¡</h3>
    <div class="form-row"><input id="itemTitle" placeholder="ë¬¼í’ˆëª… (ì˜ˆ: ì°¸ê³ ì„œ ì„¸íŠ¸)"></div>
    <div class="form-row"><textarea id="itemDesc" placeholder="ìƒì„¸ ì„¤ëª… (ìƒíƒœ, ìˆ˜ëŸ‰ ë“±)" rows="3"></textarea></div>
    <div class="form-row">
      <select id="itemCategory"><option>ì±…</option><option>ì˜ë¥˜</option><option>ì „ìê¸°ê¸°</option><option>ê¸°íƒ€</option></select>
      <select id="itemCondition"><option>ìµœìƒ</option><option>ì¢‹ìŒ</option><option>ë³´í†µ</option><option>ë‚¡ìŒ</option></select>
    </div>
    <div class="form-row">
      <input type="file" id="itemImage" accept="image/*">
      <div class="preview" id="imgPreview">ë¯¸ë¦¬ë³´ê¸°</div>
    </div>
    <div class="form-row">
      <select id="regSido">${sidoOptions}</select>
      <select id="regSigun"><option value="">ì‹œÂ·êµ°Â·êµ¬ ì„ íƒ</option></select>
    </div>
    <div class="form-actions"><button onclick="closeModal()">ì·¨ì†Œ</button><button id="doRegisterBtn">ë“±ë¡</button></div>
  `);

  // wire events inside modal
  const regSido = document.getElementById('regSido');
  const regSigun = document.getElementById('regSigun');
  const imgInput = document.getElementById('itemImage');
  const preview = document.getElementById('imgPreview');

  regSido.addEventListener('change', ()=>{
    const v = regSido.value;
    regSigun.innerHTML = '<option value="">ì‹œÂ·êµ°Â·êµ¬ ì„ íƒ</option>';
    if(v && REGION[v]) REGION[v].forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; regSigun.appendChild(o); });
  });

  imgInput.addEventListener('change', (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{ preview.style.backgroundImage = `url(${reader.result})`; preview.style.backgroundSize='cover'; preview.textContent=''; preview.dataset.src = reader.result; };
    reader.readAsDataURL(f);
  });

  document.getElementById('doRegisterBtn').addEventListener('click', doRegisterItem);
}
function doRegisterItem(){
  const title = document.getElementById('itemTitle').value.trim();
  const desc = document.getElementById('itemDesc').value.trim();
  const category = document.getElementById('itemCategory').value;
  const condition = document.getElementById('itemCondition').value;
  const sido = document.getElementById('regSido').value;
  const sigun = document.getElementById('regSigun').value;
  const preview = document.getElementById('imgPreview');
  if(!title || !desc){ alert('ë¬¼í’ˆëª…ê³¼ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const image = preview.dataset.src || ''; // allow empty image, front will show placeholder
  const it = {
    id: util.uid('it'),
    title, desc, category, condition,
    image, ownerId: currentUserId,
    sido: sido || '',
    sigun: sigun || '',
    status: 'available',
    carbon: 0, // Part2 will compute using model
    created: util.now()
  };
  items = util.load(STORAGE.ITEMS); items.unshift(it); util.save(STORAGE.ITEMS, items);
  persistAll();
  closeModal();
  renderGrid();
  renderPanel();
  alert('ë¬¼í’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

/* ---------- Render grid (filters & search) ---------- */
function renderGrid(){
  users = util.load(STORAGE.USERS);
  items = util.load(STORAGE.ITEMS);
  requests = util.load(STORAGE.REQS);
  chats = util.load(STORAGE.CHATS);

  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  const cat = document.getElementById('categoryFilter').value;
  const sido = document.getElementById('sidoSelect').value;
  const sigun = document.getElementById('sigunSelect').value;

  gridEl.innerHTML = '';
  items.filter(it=> it.status === 'available' ).forEach(it=>{
    if(cat && it.category !== cat) return;
    if(sido && it.sido !== sido) return;
    if(sigun && it.sigun !== sigun) return;
    if(q && !(it.title.toLowerCase().includes(q) || it.desc.toLowerCase().includes(q))) return;

    const owner = findUser(it.ownerId);
    const card = document.createElement('div'); card.className='card';
    const img = document.createElement('img'); img.src = it.image || placeholderImage(it.category);
    const content = document.createElement('div'); content.className='card-content';
    const h3 = document.createElement('h3'); h3.textContent = it.title;
    const p = document.createElement('p'); p.textContent = it.desc;
    const meta = document.createElement('div'); meta.className='small'; meta.textContent = `${it.category} Â· ${it.sido||''} ${it.sigun?('/ '+it.sigun):''} Â· ì†Œìœ ì: ${owner?owner.name:'-'}`;
    const footer = document.createElement('div'); footer.className='card-footer';
    const tag = document.createElement('div'); tag.className='tag'; tag.textContent = it.category;
    const btn = document.createElement('button'); btn.className='exchange-btn'; btn.textContent = 'êµí™˜ ì œì•ˆ';
    btn.addEventListener('click', ()=> openRequestModal(it.id));
    const chatBtn = document.createElement('button'); chatBtn.className='btn'; chatBtn.style.background='transparent'; chatBtn.style.border='1px solid #e6e6e6'; chatBtn.textContent='ì±„íŒ…';
    chatBtn.addEventListener('click', ()=> openOrCreateChat(it.id));
    footer.appendChild(tag); footer.appendChild(btn);
    content.appendChild(h3); content.appendChild(p); content.appendChild(meta); content.appendChild(footer);
    card.appendChild(img); card.appendChild(content);
    gridEl.appendChild(card);
  });
}

/* placeholder image by category */
function placeholderImage(category){
  const map = {
    'ì±…':'https://images.unsplash.com/photo-1512820790803-83ca734da794?auto=format&fit=crop&w=800&q=60',
    'ì˜ë¥˜':'https://images.unsplash.com/photo-1520975910870-83f4a4c3b5f1?auto=format&fit=crop&w=800&q=60',
    'ì „ìê¸°ê¸°':'https://images.unsplash.com/photo-1518779578993-ec3579fee39f?auto=format&fit=crop&w=800&q=60',
    'ê¸°íƒ€':'https://images.unsplash.com/photo-1542291026-7eec264c27ff?auto=format&fit=crop&w=800&q=60'
  };
  return map[category] || map['ê¸°íƒ€'];
}

/* ---------- Request flow (send request) ---------- */
function openRequestModal(itemId){
  if(!currentUserId){ alert('êµí™˜ ì œì•ˆí•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.'); openLoginModal(); return; }
  const it = findItem(itemId); if(!it) return alert('ë¬¼í’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  if(it.ownerId === currentUserId) return alert('ë³¸ì¸ ë¬¼í’ˆì…ë‹ˆë‹¤.');
  const owner = findUser(it.ownerId);
  openModal(`<h3>êµí™˜ ì œì•ˆ: ${it.title}</h3>
    <div class="small">ì†Œìœ ì: ${owner?owner.name:'-'}</div>
    <div class="form-row"><textarea id="reqMsg" rows="3" placeholder="êµí™˜ ì œì•ˆ ë©”ì‹œì§€ë¥¼ ì ì–´ ì£¼ì„¸ìš” (ì˜ˆ: ì´ ì°¸ê³ ì„œì™€ ì±… 2ê¶Œì„ êµí™˜í• ê²Œìš”)"></textarea></div>
    <div class="form-actions"><button onclick="closeModal()">ì·¨ì†Œ</button><button id="sendReqBtn">ì œì•ˆ ë³´ë‚´ê¸°</button></div>`);
  document.getElementById('sendReqBtn').addEventListener('click', ()=> sendRequest(itemId));
}

function sendRequest(itemId){
  const msg = document.getElementById('reqMsg').value.trim();
  const it = findItem(itemId);
  const r = { id: util.uid('req'), itemId, fromUserId: currentUserId, toUserId: it.ownerId, message: msg, status:'pending', created: util.now() };
  requests = util.load(STORAGE.REQS); requests.push(r); util.save(STORAGE.REQS, requests);
  // create chat thread if none
  chats = util.load(STORAGE.CHATS);
  let thread = chats.find(c=> c.itemId === itemId && c.participants.includes(currentUserId) && c.participants.includes(it.ownerId));
  if(!thread){
    thread = { id: util.uid('ch'), itemId, topic: it.title, participants: [currentUserId, it.ownerId], messages: [] };
    chats.push(thread); util.save(STORAGE.CHATS, chats);
  }
  thread.messages.push({ id: util.uid('m'), from: currentUserId, text: msg || 'êµí™˜ ì œì•ˆë“œë¦½ë‹ˆë‹¤.', time: util.now() });
  util.save(STORAGE.CHATS, chats);
  persistAll();
  closeModal();
  renderPanel();
  alert('êµí™˜ ì œì•ˆì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì†Œìœ ìì˜ ì•Œë¦¼ì—ì„œ í™•ì¸ë©ë‹ˆë‹¤.');
}

/* ---------- Respond to requests (accept/reject) ---------- */
function respondRequest(reqId, action){
  requests = util.load(STORAGE.REQS);
  const r = requests.find(x=>x.id===reqId); if(!r) return;
  if(action === 'rejected'){ r.status = 'rejected'; util.save(STORAGE.REQS, requests); persistAll(); renderPanel(); alert('ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.'); return; }
  if(action === 'accepted'){
    r.status = 'accepted';
    // perform trade: mark item as traded, award points (Part2 will have points calc)
    items = util.load(STORAGE.ITEMS);
    const it = items.find(i=> i.id === r.itemId);
    if(!it){ alert('ì•„ì´í…œì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
    it.status = 'traded';
    util.save(STORAGE.ITEMS, items);
    // update user stats
    users = util.load(STORAGE.USERS);
    const proposer = users.find(u=>u.id===r.fromUserId);
    const owner = users.find(u=>u.id===r.toUserId);
    if(proposer){ proposer.trades = (proposer.trades||0) + 1; }
    if(owner){ owner.trades = (owner.trades||0) + 1; }
    util.save(STORAGE.USERS, users);
    // append chat message
    chats = util.load(STORAGE.CHATS);
    let thread = chats.find(c=> c.itemId === it.id && c.participants.includes(r.fromUserId) && c.participants.includes(r.toUserId));
    if(!thread){
      thread = { id: util.uid('ch'), itemId: it.id, topic: it.title, participants: [r.fromUserId, r.toUserId], messages: [] };
      chats.push(thread);
    }
    thread.messages.push({ id: util.uid('m'), from: r.toUserId, text: 'ê±°ë˜ë¥¼ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!', time: util.now() });
    util.save(STORAGE.CHATS, chats);
    util.save(STORAGE.REQS, requests);
    persistAll();
    renderGrid(); renderPanel();
    alert('ê±°ë˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
  }
}

/* expose respondRequest to window (used by panel buttons) */
window.respondRequest = respondRequest;

/* ---------- Chat functions ---------- */
function openOrCreateChat(itemId){
  if(!currentUserId){ alert('ì±„íŒ…ì„ ì´ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.'); openLoginModal(); return; }
  const it = findItem(itemId); if(!it) return;
  chats = util.load(STORAGE.CHATS);
  let thread = chats.find(c=> c.itemId === itemId && c.participants.includes(currentUserId));
  if(!thread){
    thread = { id: util.uid('ch'), itemId, topic: it.title, participants: [currentUserId, it.ownerId], messages: [] };
    chats.push(thread); util.save(STORAGE.CHATS, chats);
  }
  openChatModal(thread.id);
}
function openChatModal(threadId){
  const thread = findChat(threadId);
  if(!thread) return alert('ì±„íŒ…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  let html = `<h3>ì±„íŒ… â€” ${thread.topic}</h3><div id="chatBox" style="max-height:360px;overflow:auto;border:1px solid #f0f0f0;padding:8px;margin-bottom:8px">`;
  thread.messages.forEach(m=>{
    const from = findUser(m.from) || {name:'ìµëª…'};
    const side = (m.from === currentUserId) ? 'right' : 'left';
    html += `<div style="margin:6px 0;text-align:${side}"><div style="display:inline-block;background:${m.from===currentUserId? 'linear-gradient(135deg,var(--main-green),var(--light-green))':'#f4f4f4'};color:${m.from===currentUserId? '#fff':'#333'};padding:8px;border-radius:8px;max-width:80%;">${m.text}</div><div class="small" style="margin-top:4px">${from.name}</div></div>`;
  });
  html += `</div><div class="form-row"><input id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></div><div class="form-actions"><button onclick="closeModal()">ë‹«ê¸°</button><button id="sendChatBtn">ì „ì†¡</button></div>`;
  openModal(html);
  document.getElementById('sendChatBtn').addEventListener('click', ()=> {
    const txt = document.getElementById('chatInput').value.trim(); if(!txt) return;
    thread.messages.push({ id: util.uid('m'), from: currentUserId, text: txt, time: util.now() });
    util.save(STORAGE.CHATS, chats);
    persistAll();
    openChatModal(thread.id);
  });
}

/* ---------- Panel rendering (notifications, chats, profile) ---------- */
function renderPanel(){
  users = util.load(STORAGE.USERS);
  items = util.load(STORAGE.ITEMS);
  requests = util.load(STORAGE.REQS);
  chats = util.load(STORAGE.CHATS);

  const me = findUser(currentUserId);
  document.getElementById('avatar').textContent = me ? me.name.slice(0,2) : '?';
  document.getElementById('profileName').textContent = me ? me.name : 'ë¹„ë¡œê·¸ì¸';
  document.getElementById('profileSchool').textContent = me ? me.school : 'í•™êµ/ì§€ì—­ ì…ë ¥ í•„ìš”';
  document.getElementById('profilePoints').textContent = me ? (me.points || 0) : 0;
  document.getElementById('profileTrades').textContent = me ? (me.trades || 0) : 0;

  // notifications (requests to me)
  const notifList = document.getElementById('notifList'); notifList.innerHTML = '';
  if(!me){ notifList.innerHTML = '<div class="small">ë¡œê·¸ì¸í•˜ë©´ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>'; }
  else {
    const mine = requests.filter(r => r.toUserId === me.id && r.status === 'pending');
    if(mine.length === 0) notifList.innerHTML = '<div class="small">ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    else mine.forEach(r=>{
      const from = findUser(r.fromUserId) || {name:'ìµëª…'}; const it = findItem(r.itemId) || {title:'[ì‚­ì œëœ ë¬¼í’ˆ]'};
      const div = document.createElement('div'); div.style.padding='8px'; div.style.border='1px dashed #eee'; div.style.marginBottom='8px';
      div.innerHTML = `<div style="font-weight:700">${from.name}</div><div class="small">${it.title}ì— ëŒ€í•œ êµí™˜ ì œì•ˆ</div>
        <div style="margin-top:8px;text-align:right"><button onclick="respondRequest('${r.id}','accepted')" class="btn">ìˆ˜ë½</button> <button onclick="respondRequest('${r.id}','rejected')">ê±°ì ˆ</button></div>`;
      notifList.appendChild(div);
    });
  }

  // chat list (threads involving me)
  const chatListEl = document.getElementById('chatList'); chatListEl.innerHTML = '';
  if(!me) chatListEl.innerHTML = '<div class="small">ë¡œê·¸ì¸í•˜ë©´ ì±„íŒ… ëª©ë¡ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
  else {
    const myThreads = chats.filter(c => c.participants.includes(me.id));
    if(myThreads.length === 0) chatListEl.innerHTML = '<div class="small">ì±„íŒ… ìŠ¤ë ˆë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    else myThreads.forEach(t=>{
      const otherId = t.participants.find(p=>p!==me.id) || null;
      const other = findUser(otherId) || {name:'ìµëª…'};
      const el = document.createElement('div'); el.className='chat-item'; el.textContent = `${other.name} Â· ${t.topic}`;
      el.onclick = ()=> openChatModal(t.id);
      chatListEl.appendChild(el);
    });
  }
}

/* ---------- Placeholder for API integration points ----------
   - processPayment(order): add real payment server call
   - createShipping(order): add courier API call
   These are intentionally left as stubs in Part1; Part2 will include example wiring.
*/
async function processPayment(order){ console.log('PAYMENT STUB', order); return {success:true, providerId:'MOCK'}; }
async function createShipping(order){ console.log('SHIPPING STUB', order); return {success:true, tracking:'MOCK_TRK'}; }

/* ---------- Initial render ---------- */
renderGrid();
renderPanel();

/* ---------- Bind search/filter ---------- */
document.getElementById('searchInput').addEventListener('input', ()=> renderGrid());
document.getElementById('categoryFilter').addEventListener('change', ()=> renderGrid());
document.getElementById('sidoSelect').addEventListener('change', ()=> renderGrid());
document.getElementById('sigunSelect').addEventListener('change', ()=> renderGrid());

/* ---------- Utility: expose some functions for debugging in console ---------- */
window._TT = {
  util, REGION, renderGrid, renderPanel, openRegisterModal, openLoginModal, openChatModal, processPayment, createShipping
};
</script>
</body>
</html>
<style>
#footerPanel {
  position: fixed;
  bottom: 0;
  width: 100%;
  background-color: #e8f5e9;
  border-top: 1px solid #cfd8dc;
  display: flex;
  justify-content: space-around;
  padding: 10px 0;
}
#footerPanel button {
  background-color: #3b7a57;
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
}
#footerPanel button:hover {background-color:#2e5e43;}

.modal {
  display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.4); justify-content:center; align-items:center;
}
.modal-content {
  background:white; padding:20px; border-radius:8px; width:90%; max-width:500px;
  max-height:90vh; overflow:auto;
}
.modal h3 {color:#3b7a57;}
.shop-item {
  display:flex; justify-content:space-between; align-items:center;
  border-bottom:1px solid #ccc; padding:8px 0;
}
.progress-bar {
  width:100%; background:#c8e6c9; border-radius:5px; height:20px; margin-top:10px;
}
.progress-fill {
  background:#3b7a57; height:100%; border-radius:5px; width:0%;
}
</style>

<div id="footerPanel">
  <button onclick="openModal('shopModal')">í¬ì¸íŠ¸ ìƒì </button>
  <button onclick="openModal('rankModal')">ë­í‚¹</button>
  <button onclick="openModal('ecoModal')">íƒ„ì†Œì ˆê° í˜„í™©</button>
  <button onclick="openModal('payModal')">ê²°ì œ/ë°°ì†¡</button>
</div>

<!-- í¬ì¸íŠ¸ ìƒì  -->
<div id="shopModal" class="modal">
  <div class="modal-content">
    <h3>í¬ì¸íŠ¸ ìƒì </h3>
    <div id="shopList"></div>
    <button onclick="closeModal('shopModal')">ë‹«ê¸°</button>
  </div>
</div>

<!-- ë­í‚¹ -->
<div id="rankModal" class="modal">
  <div class="modal-content">
    <h3>ê±°ë˜ ë­í‚¹</h3>
    <ol id="rankList"></ol>
    <button onclick="closeModal('rankModal')">ë‹«ê¸°</button>
  </div>
</div>

<!-- íƒ„ì†Œì ˆê° í˜„í™© -->
<div id="ecoModal" class="modal">
  <div class="modal-content">
    <h3>íƒ„ì†Œ ì ˆê° ëŒ€ì‹œë³´ë“œ</h3>
    <p>ì§€ê¸ˆê¹Œì§€ ì ˆì•½ëœ íƒ„ì†Œ ë°°ì¶œëŸ‰:</p>
    <div class="progress-bar">
      <div class="progress-fill" id="carbonBar"></div>
    </div>
    <p><span id="carbonAmount">0</span> kg COâ‚‚ ì ˆê°</p>
    <button onclick="closeModal('ecoModal')">ë‹«ê¸°</button>
  </div>
</div>

<!-- ê²°ì œ/ë°°ì†¡ -->
<div id="payModal" class="modal">
  <div class="modal-content">
    <h3>ê²°ì œ / ë°°ì†¡ ì‹œìŠ¤í…œ (API ì—°ë™ ìë¦¬)</h3>
    <p>ì•„ë˜ ë²„íŠ¼ì€ ì‹¤ì œ ê²°ì œ/ë°°ì†¡ API(Toss, Stripe, CJëŒ€í•œí†µìš´ ë“±)ì— ì—°ê²°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <input type="text" placeholder="ê±°ë˜ ìƒí’ˆëª…" id="payItem"><br>
    <input type="number" placeholder="ê¸ˆì•¡(ì›)" id="payAmount"><br>
    <button onclick="mockPayment()">ê²°ì œí•˜ê¸°</button>
    <p id="paymentStatus" style="color:green;"></p>
    <button onclick="closeModal('payModal')">ë‹«ê¸°</button>
  </div>
</div>

<script>
// ----- í¬ì¸íŠ¸ ì‹œìŠ¤í…œ -----
let points = parseInt(localStorage.getItem("ecoPoints") || "100");
const shopItems = [
  {name:"ë‹¤íšŒìš© í…€ë¸”ëŸ¬", cost:50},
  {name:"ì¹œí™˜ê²½ ì¥ë°”êµ¬ë‹ˆ", cost:30},
  {name:"ë¦¬í•„ ì„¸ì œ ì„¸íŠ¸", cost:70},
  {name:"ì—…ì‚¬ì´í´ ë…¸íŠ¸ë¶ íŒŒìš°ì¹˜", cost:120},
  {name:"ì—ì½” ìŠ¤íŠ¸ë¡œ ì„¸íŠ¸", cost:25},
  {name:"ì¬í™œìš© ë©´ í‹°ì…”ì¸ ", cost:60},
  {name:"ì¹œí™˜ê²½ ë¹„ëˆ„ ì„¸íŠ¸", cost:40},
  {name:"ëŒ€ë‚˜ë¬´ ì¹«ì†” 2ê°œ ì„¸íŠ¸", cost:35},
  {name:"ì²œì—° ì† ì„¸ì •ì œ", cost:45},
  {name:"ì¬ìƒ ì¢…ì´ í”Œë˜ë„ˆ", cost:55}
];

function openModal(id){
  document.getElementById(id).style.display='flex';
  if(id==='shopModal') loadShop();
  if(id==='rankModal') loadRank();
  if(id==='ecoModal') updateCarbon();
}
function closeModal(id){document.getElementById(id).style.display='none';}

function loadShop(){
  const div=document.getElementById("shopList");
  div.innerHTML=`<p>í˜„ì¬ í¬ì¸íŠ¸: <b>${points}</b> P</p>`;
  shopItems.forEach((item,i)=>{
    const box=document.createElement("div");
    box.className="shop-item";
    box.innerHTML=`<span>${item.name} (${item.cost}P)</span>
                   <button onclick="buyItem(${i})">êµ¬ë§¤</button>`;
    div.appendChild(box);
  });
}
function buyItem(i){
  const item=shopItems[i];
  if(points>=item.cost){
    points-=item.cost;
    localStorage.setItem("ecoPoints",points);
    alert(`${item.name}ì„(ë¥¼) êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤!`);
    loadShop();
  } else alert("í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
}

// ----- ë­í‚¹ -----
function loadRank(){
  const rank=document.getElementById("rankList");
  const items=JSON.parse(localStorage.getItem("ecoItems")||"[]");
  const rankData={};
  items.forEach(i=>{
    if(!rankData[i.region]) rankData[i.region]=0;
    rankData[i.region]++;
  });
  const sorted=Object.entries(rankData).sort((a,b)=>b[1]-a[1]);
  rank.innerHTML='';
  sorted.forEach(([region,count])=>{
    const li=document.createElement("li");
    li.textContent=`${region} - ${count}ê±´ ê±°ë˜`;
    rank.appendChild(li);
  });
  if(sorted.length===0) rank.innerHTML="<p>ì•„ì§ ê±°ë˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
}

// ----- íƒ„ì†Œ ì ˆê° ëŒ€ì‹œë³´ë“œ -----
function updateCarbon(){
  const items=JSON.parse(localStorage.getItem("ecoItems")||"[]");
  const saved = items.length * 1.5; // ê±°ë˜ë‹¹ í‰ê·  1.5kg COâ‚‚ ì ˆê°
  document.getElementById("carbonAmount").textContent=saved.toFixed(1);
  const bar=document.getElementById("carbonBar");
  const percent=Math.min(saved/100*100,100);
  bar.style.width=percent+"%";
}

// ----- ê²°ì œ/ë°°ì†¡ ëª¨ì˜ ëª¨ë“ˆ -----
function mockPayment(){
  const name=document.getElementById("payItem").value;
  const amount=document.getElementById("payAmount").value;
  if(!name||!amount){alert("ìƒí’ˆëª…ê³¼ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.");return;}
  document.getElementById("paymentStatus").textContent="ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ (ëª¨ì˜)";
  // ì—¬ê¸°ì— ì‹¤ì œ Toss/Stripe API ì—°ë™ ì½”ë“œ ì¶”ê°€ ê°€ëŠ¥
}

// ----- ê±°ë˜ ì‹œ í¬ì¸íŠ¸/íƒ„ì†Œ ë°˜ì˜ -----
function tradeItem(index){
  const data=JSON.parse(localStorage.getItem("ecoItems")||"[]");
  const item=data[index];
  alert(`${item.name} ê±°ë˜ ìš”ì²­ ì™„ë£Œ!`);
  points+=10; // ê±°ë˜ ì‹œ 10í¬ì¸íŠ¸ ì ë¦½
  localStorage.setItem("ecoPoints",points);
}
</script>
